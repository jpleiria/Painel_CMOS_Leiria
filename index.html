<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel CMOS Leiria</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Orbitron:wght@500;700;900&family=Outfit:wght@300;400;600;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- RESET & BASICS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        :root { 
            /* Cores Base */
            --sun-color: #fbbf24;
            --rain-color: #60a5fa;
            /* Cores Escuras */
            --bg-dark: #0f172a; 
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
        }

        /* --- FONT STYLE --- */
        body { background-color: var(--bg-dark); color: var(--text-primary); font-family: 'Outfit', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        h1 { font-family: 'Orbitron', sans-serif; font-size: 1.5em; font-weight: 700; color: var(--text-primary); margin-bottom: 20px; }
        .location { font-family: 'Share Tech Mono', monospace; font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; }
        
        /* --- MAIN TEMP AREA --- */
        .main-weather { display: flex; flex-direction: column; align-items: center; margin-bottom: 30px; }
        .main-icon { font-size: 8em; color: var(--sun-color); margin-bottom: 10px; transition: color 0.5s; }
        .main-temp { font-family: 'Outfit', sans-serif; font-size: 4em; font-weight: 800; }
        .main-desc { font-family: 'Outfit', sans-serif; font-size: 1.2em; font-weight: 600; color: var(--text-secondary); text-transform: capitalize; text-align: center; }

        /* --- DAILY CONTAINER --- */
        .forecast-container { width: 100%; max-width: 800px; padding: 15px; background-color: rgba(255, 255, 255, 0.05); border-radius: 12px; margin-bottom: 20px; }
        .forecast-title { font-family: 'Chakra Petch', sans-serif; font-size: 1.1em; font-weight: 600; margin-bottom: 15px; color: var(--text-primary); border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 10px; }
        .forecast-row { display: flex; justify-content: space-around; overflow-x: auto; padding-bottom: 10px; }
        .f-temp { font-family: 'Outfit', sans-serif; font-size: 1em; font-weight: 600; }
        .min-temp { color: var(--text-secondary); font-weight: 300; margin-left: 2px; }
        
        /* Specifics for Daily Forecast (Vertical Layout) */
        #daily-row { flex-direction: column; gap: 10px; }
        #daily-row .forecast-unit { flex-direction: row; justify-content: space-between; width: 100%; padding: 0; display: flex; align-items: center;} /* Corrigido display e alinhamento */
        #daily-row .f-time { font-family: 'Share Tech Mono', monospace; font-size: 1em; margin-bottom: 0; color: var(--text-primary); font-weight: 500; min-width: 80px; text-align: left; }
        #daily-row .f-icon { margin: 0 10px; font-size: 1.8em; flex-grow: 1; text-align: center; }
        #daily-row .f-temp-group { display: flex; align-items: center; min-width: 80px; justify-content: flex-end; }

        /* Spinner/Loading */
        .spinner { border: 4px solid rgba(255, 255, 255, 0.1); border-top: 4px solid var(--sun-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-top: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="location">Localização (Dados IPMA)</div>
    <h1>LEIRIA</h1>

    <div class="main-weather">
        <i id="current-icon" class="fa-solid fa-cloud-question main-icon"></i>
        <span id="current-temp" class="main-temp">--°</span>
        <span id="current-description" class="main-desc">A carregar dados...</span>
    </div>

    <div class="forecast-container">
        <div class="forecast-title">Previsão para 5 dias (IPMA)</div>
        <div id="daily-row" class="forecast-row">
            <div class="spinner"></div>
        </div>
    </div>

    <script>
        // Mapeamento simplificado dos ID de Tipo de Tempo do IPMA para ícones Font Awesome
        function getWeatherIconIPMA(id, weatherTypesMap) {
            const weatherId = parseInt(id);
            let faClass = 'fa-question-circle'; // Default
            const desc = weatherTypesMap.get(weatherId) || 'Condição Desconhecida';

            switch (weatherId) {
                case 1: case 100: faClass = 'fa-sun'; break; // Céu limpo
                case 2: case 3: faClass = 'fa-cloud-sun'; break; // Céu pouco/parcialmente nublado
                case 4: case 5: faClass = 'fa-cloud'; break; // Céu muito nublado/encoberto
                case 6: case 8: case 12: faClass = 'fa-cloud-showers-heavy'; break; // Chuva/aguaceiros fortes
                case 7: case 9: case 10: case 11: faClass = 'fa-cloud-rain'; break; // Chuva/aguaceiros fracos/períodos
                case 13: faClass = 'fa-cloud-drizzle'; break; // Chuvisco
                case 14: case 15: faClass = 'fa-smog'; break; // Neblina/Nevoeiro
                case 16: case 21: case 26: faClass = 'fa-snowflake'; break; // Neve
                case 17: case 18: case 19: case 20: faClass = 'fa-cloud-bolt'; break; // Trovoadas/Possibilidade de trovoada
                default: faClass = 'fa-cloud-question';
            }

            return { faClass: faClass, desc: desc };
        }

        // Função para formatar números (ou devolver 'ND' se não for um número válido)
        function formatTemp(tempStr) {
            // Verifica se o valor é válido antes de arredondar
            const temp = parseFloat(tempStr);
            return isNaN(temp) ? 'ND' : `${Math.round(temp)}°`;
        }

        function handleError(message) {
            console.error("ERRO:", message);
            document.getElementById('current-icon').className = 'fa-solid fa-triangle-exclamation main-icon';
            document.getElementById('current-temp').textContent = "---";
            document.getElementById('current-description').textContent = "Erro ao carregar dados do IPMA. Verifique a Consola (F12).";
            document.getElementById('daily-row').innerHTML = `<div style="color:#ef4444; text-align:center; width:100%;">Falha no carregamento: ${message}</div>`;
        }


        async function fetchWeatherData() {
            const LEIRIA_LOCAL_ID = '1110900';
            const FORECAST_URL = `https://api.ipma.pt/open-data/forecast/meteorology/cities/daily/${LEIRIA_LOCAL_ID}.json`;
            const WEATHER_TYPES_URL = 'https://api.ipma.pt/open-data/weather-type-classe.json';

            try {
                // 1. CARREGAR O MAPA DE TIPOS DE TEMPO (Necessário para a tradução)
                let typesResponse = await fetch(WEATHER_TYPES_URL);
                if (!typesResponse.ok) {
                    throw new Error(`Falha ao obter Tipos de Tempo (código ${typesResponse.status}).`);
                }
                const weatherTypesData = await typesResponse.json();
                if (!weatherTypesData.data) {
                    throw new Error("Resposta de Tipos de Tempo inválida.");
                }
                const weatherTypesMap = new Map(weatherTypesData.data.map(item => [item.idWeatherType, item.descWeatherTypePT]));


                // 2. CARREGAR A PREVISÃO DIÁRIA DE LEIRIA
                let forecastResponse = await fetch(FORECAST_URL);
                if (!forecastResponse.ok) {
                    throw new Error(`Falha ao obter Previsão (código ${forecastResponse.status}).`);
                }
                const forecastData = await forecastResponse.json();
                const forecast = forecastData.data;
                
                if (!forecast || forecast.length === 0) {
                    throw new Error("O IPMA não devolveu dados de previsão para Leiria.");
                }
                

                // 3. DADOS ATUAIS/DE HOJE (Primeiro dia do array)
                const today = forecast[0];
                const todayInfo = getWeatherIconIPMA(today.idWeatherType, weatherTypesMap);
                const maxTemp = formatTemp(today.tMax);
                const minTemp = formatTemp(today.tMin);
                
                document.getElementById('current-icon').className = `fa-solid ${todayInfo.faClass} main-icon`;
                document.getElementById('current-temp').textContent = maxTemp;
                document.getElementById('current-description').innerHTML = `${todayInfo.desc}<br>(Máx: ${maxTemp} / Mín: ${minTemp})`;


                // 4. PREVISÃO DIÁRIA (os 5 dias)
                const dCont = document.getElementById('daily-row');
                dCont.innerHTML = ''; // Limpar o spinner

                // Loop pelos 5 dias de previsão
                forecast.forEach((dayData, index) => {
                    // Ignora se não houver data ou tipo de tempo
                    if (!dayData.forecastDate || !dayData.idWeatherType) return; 

                    const d = new Date(dayData.forecastDate);
                    
                    let dName;
                    if (index === 0) {
                        dName = 'Hoje';
                    } else {
                        // Ex: "seg." -> "Seg"
                        let dayShort = d.toLocaleDateString('pt-PT', { weekday: 'short' }).replace('.', '');
                        dName = dayShort.charAt(0).toUpperCase() + dayShort.slice(1);
                    }
                    
                    const wInfo = getWeatherIconIPMA(dayData.idWeatherType, weatherTypesMap);
                    
                    dCont.innerHTML += `
                        <div class="forecast-unit">
                            <span class="f-time">${dName}</span>
                            <i class="fa-solid ${wInfo.faClass} f-icon" title="${wInfo.desc}"></i>
                            <div class="f-temp-group">
                                <span class="f-temp">${formatTemp(dayData.tMax)}</span> 
                                <span class="f-temp min-temp">/${formatTemp(dayData.tMin)}</span>
                            </div>
                        </div>
                    `;
                });

            } catch (error) {
                // Chama a função de tratamento de erro com a mensagem detalhada
                handleError(error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', fetchWeatherData);
    </script>
</body>
</html>